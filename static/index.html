<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <!-- Navigation Bar -->
        <nav class="nav-bar">
        <ul class="nav-links">
        <li><a href="../../">Account</a></li>
            <li><a href="index.html">Home</a></li>
            <li><a href="Overview/overview.html">Overview</a></li>
            <li><a href="Categories/categories.html">Categories</a></li>
            <li><a href="Analytics/analytics.html">Analytics</a></li>
        </ul>
        </nav>

        <input type="button" id="btnClearLocalStorage" value="Clear Local Storage"/>

        <main class="page-content">
            <h1 id="title">Input Expenses</h1>

   	        <input type="text" id="addCategory" name="addCategory"/>
	        <label for="addCategory">Add New Category</label>

            <form id="expense-form">
                <div class="form-field">
                    <label for="amount">Amount ($)</label>
                    <input type="number" id="amount" name="amount" min="0" step="0.01" placeholder="0.00" required>
                </div>

                <div class="form-field">
                    <label for="label">Expense Name / Description (Optional)</label>
                    <input type="text" id="label" name="label" placeholder="e.g., Walmart, McDonalds">
                </div>

                <div class="form-field">
                    <label for="category">Category</label>
                    <select id="category" name="category" required>
                        <option value="" disabled selected>Select a category</option>
                        <option value="housing">Housing</option>
                        <option value="utilities">Utilities</option>
                        <option value="transportation">Transportation</option>
                        <option value="food">Food</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="health">Health</option>
                        <option value="savings">Savings</option>
                        <option value="miscellaneous">Miscellaneous</option>
                    </select>
                </div>

                <div class="form-field">
                    <label for="date">Date (DD/MM/YYYY)</label>
                    <input type="text" id="date" name="date" placeholder="DD/MM/YYYY" inputmode="numeric" pattern="^(0[1-9]|[12][0-9]|3[01])/(0[1-9]|1[0-2])/[0-9]{4}$" title="Enter the date as DD/MM/YYYY" required>
                </div>

                <div class="form-field">
                    <label for="impulse">Impulse Purchase</label>
                    <select id="impulse" name="impulse" required>
                        <option value="" disabled selected>Was this an impulse purchase?</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>

                <button type="submit">Submit Expense</button>

            </form>

            <section id="monthly-budget-section">
                <h2>Monthly Budget</h2>
                <div class="form-field">
                    <label for="monthly-budget">Set Monthly Budget for This Month ($)</label>
                    <input type="number" id="monthly-budget" name="monthly-budget" min="0" step="0.01" placeholder="0.00">
                </div>
                </section>



        </main>
        <div class="page-content" style="max-width: 680px">
        <h1>CSV Import</h1>
        <nav class="nav-bar">
	        <input type="file" id="upload" accept=".csv"/>
	        <input type="radio" id="mode0" name="mode"/>
	        <label for="mode0">Select Column</label>
	        <input type="radio" id="mode1" name="mode"/>
	        <label for="mode1">Ignore Row</label>
	        <input type="button" id="btnCategory" value="Set Category Column"/>
	        <input type="button" id="btnAmount" value="Set Amount Column"/>
	        <input type="button" id="btnLabel" value="Set Label Column"/>
	        <input type="button" id="btnDate" value="Set Date Column"/>
	        <input type="button" id="btnFinalize" value="Finalize"/>
	        <p></p>
	        <div id="preview-csv">
					<table id="table"></table>
	        </div>
        </nav>
        </div>
        <div id="impulse-modal" class="modal" aria-hidden="true">
            <div class="modal-content">
                <h2>Confirm Impulse Purchase</h2>
                <p id="impulse-modal-message"></p>
                <div class="modal-actions">
                    <button id="impulse-confirm" class="modal-btn primary">Yes, continue</button>
                    <button id="impulse-cancel" class="modal-btn secondary">No, go back</button>
                </div>
            </div>
        </div>
        <script src="script.js"></script>
        <div class="page-content" style="max-width: 100%">
        <h1>PDF Import</h1>

        <input type="file" id="file-input" accept="application/pdf">
        <input type="button" id="pdfAmount" value="Set Amount Column"/>
        <input type="button" id="pdfCategory" value="Set Category Column"/>
        <input type="button" id="pdfDate" value="Set Date Column"/>
        <input type="button" id="pdfFinalize" value="Finalize"/>
        <div id="pages-container"></div>

        <div id="info"></div>
        </div>
        <script type="module">
          import * as pdfjsLib from "https://unpkg.com/pdfjs-dist@5.4.449/build/pdf.mjs";
          pdfjsLib.GlobalWorkerOptions.workerSrc =
            "https://unpkg.com/pdfjs-dist@5.4.449/build/pdf.worker.mjs";

          const fileInput = document.getElementById("file-input");
          const pagesContainer = document.getElementById("pages-container");
          const infoDiv = document.getElementById("info");

          let pdfDoc = null;

          // Global selection across ALL pages:
          // [{ pageNum, item }]
          let selectedItems = [];
          let selAmounts = [];
          let selCategories = [];
          let selDates = [];

          // Per-page contexts so we can redraw highlights everywhere
          // pageContexts[pageNum] = { textItems, viewport, overlayCtx, overlayCanvas }
          const pageContexts = {};

          // Drag state (global â€“ only one drag at a time)
          let isDragging = false;
          let dragStart = { x: 0, y: 0 };
          let dragEnd = { x: 0, y: 0 };
          let currentPageBeingDragged = null;

          function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
          }

          const pdfFinalize = document.getElementById("pdfFinalize");
          pdfFinalize.addEventListener("click", async (e) => {
		   	console.log(selAmounts);
		    console.log(selCategories);
		    console.log(selDates);
			for (let i = 0; i < selAmounts.length; i++) {
				if (selAmounts[i] < 0.0) {
					continue;
				}
				await add_transaction(	selCategories[i],
				selAmounts[i],
				selDates[i],
				false,
				"",);
				await sleep(50);
			}
          });
          const pdfAmount = document.getElementById("pdfAmount");
          pdfAmount.addEventListener("click", async (e) => {
          	for (let i = 0; i < selectedItems.length; i++) {
           		let testString = selectedItems[i].item.str;
         		selAmounts.push(parseFloat(testString.replace(/[^0-9.-]/g, "")));
           }
          });
          const pdfCategory = document.getElementById("pdfCategory");
          pdfCategory.addEventListener("click", async (e) => {
          	for (let i = 0; i < selectedItems.length; i++) {
           		let testString = selectedItems[i].item.str;
         		selCategories.push(testString);
           }
          });
          function convertDate(str) {
            const MONTHS = {
              JAN: 1, FEB: 2, MAR: 3, APR: 4, MAY: 5, JUN: 6,
              JUL: 7, AUG: 8, SEP: 9, OCT: 10, NOV: 11, DEC: 12
            };

            const [monStr, dayStr] = str.trim().split(/\s+/);
            const month = MONTHS[monStr.toUpperCase()];
            const day = parseInt(dayStr, 10);
            const year = 2025;

            // zero-pad
            const dd = day.toString().padStart(2, "0");
            const mm = month.toString().padStart(2, "0");

            return `${dd}/${mm}/${year}`;
          }
          const pdfDate = document.getElementById("pdfDate");
          pdfDate.addEventListener("click", async (e) => {
          	for (let i = 0; i < selectedItems.length; i++) {
         		let testString = selectedItems[i].item.str;
         		selDates.push(convertDate(testString));
           }
          });


          fileInput.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (ev) => {
              const data = new Uint8Array(ev.target.result);
              pagesContainer.innerHTML = "";
              infoDiv.textContent = "";

              selectedItems = [];
              Object.keys(pageContexts).forEach(k => delete pageContexts[k]);

              pdfDoc = await pdfjsLib.getDocument({ data }).promise;
              infoDiv.textContent = `Loaded PDF with ${pdfDoc.numPages} pages.\nRendering...`;

              // Render all pages
              for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                await renderPageView(pageNum);
              }

              infoDiv.textContent += `\nDone. Click or drag on any page to select text.`;
            };
            reader.readAsArrayBuffer(file);
          });

          // --- Helpers ---

          function applyViewport(point, viewport) {
            const [A, B, C, D, E, F] = viewport.transform;
            const [x, y] = point;
            return [
              A * x + C * y + E,
              B * x + D * y + F,
            ];
          }

          function pdfBoxToCanvasBox(pdfBox, viewport) {
            const p1 = applyViewport([pdfBox.x1, pdfBox.y1], viewport);
            const p2 = applyViewport([pdfBox.x2, pdfBox.y2], viewport);

            const left   = Math.min(p1[0], p2[0]);
            const top    = Math.min(p1[1], p2[1]);
            const right  = Math.max(p1[0], p2[0]);
            const bottom = Math.max(p1[1], p2[1]);

            return {
              x: left,
              y: top,
              width: right - left,
              height: bottom - top,
            };
          }

          function rectsIntersect(r1, r2) {
            return !(
              r2.x > r1.x + r1.width ||
              r2.x + r2.width < r1.x ||
              r2.y > r1.y + r1.height ||
              r2.y + r2.height < r1.y
            );
          }

          function getCanvasCoords(canvas, event) {
            const rect = canvas.getBoundingClientRect();
            return {
              x: event.clientX - rect.left,
              y: event.clientY - rect.top,
            };
          }

          function drawItemHighlight(ctx, box) {
            ctx.save();
            ctx.fillStyle = "rgba(255, 255, 0, 0.35)";
            ctx.strokeStyle = "rgba(255, 200, 0, 1)";
            ctx.lineWidth = 1;
            ctx.fillRect(box.x, box.y, box.width, box.height);
            ctx.strokeRect(box.x, box.y, box.width, box.height);
            ctx.restore();
          }

          function drawSelectionRect(ctx, sel) {
            ctx.save();
            ctx.strokeStyle = "rgba(0, 128, 255, 1)";
            ctx.fillStyle = "rgba(0, 128, 255, 0.15)";
            ctx.lineWidth = 1;
            ctx.fillRect(sel.x, sel.y, sel.width, sel.height);
            ctx.strokeRect(sel.x, sel.y, sel.width, sel.height);
            ctx.restore();
          }

          function getSelectionRect() {
            const x = Math.min(dragStart.x, dragEnd.x);
            const y = Math.min(dragStart.y, dragEnd.y);
            const width = Math.abs(dragEnd.x - dragStart.x);
            const height = Math.abs(dragEnd.y - dragStart.y);
            return { x, y, width, height };
          }

          // Redraw all global highlights, plus optional live selection rect
          function redrawGlobalHighlights(selectionRect = null) {
            // Clear overlays on all pages
            for (const pageNum in pageContexts) {
              const { overlayCtx, overlayCanvas } = pageContexts[pageNum];
              overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            }

            // Draw persistent selection on each page
            for (const sel of selectedItems) {
              const { pageNum, item } = sel;
              const ctxInfo = pageContexts[pageNum];
              if (!ctxInfo) continue;

              const { viewport, overlayCtx } = ctxInfo;
              const box = pdfBoxToCanvasBox(item.pdfBox, viewport);
              drawItemHighlight(overlayCtx, box);
            }

            // Draw live drag rectangle on the current page, if any
            if (
              selectionRect &&
              selectionRect.width > 0 &&
              selectionRect.height > 0 &&
              currentPageBeingDragged != null
            ) {
              const ctxInfo = pageContexts[currentPageBeingDragged];
              if (ctxInfo) {
                drawSelectionRect(ctxInfo.overlayCtx, selectionRect);
              }
            }
          }

          // --- Render a single page with its own canvases and events ---

          async function renderPageView(pageNum) {
            const page = await pdfDoc.getPage(pageNum);
            const scale = 1.5;
            const viewport = page.getViewport({ scale });

            // DOM structure:
            // wrapper
            //   label
            //   pageCanvasContainer
            //     pdfCanvas
            //     overlayCanvas
            const wrapper = document.createElement("div");
            wrapper.className = "page-wrapper";

            const label = document.createElement("div");
            label.className = "page-label";
            label.textContent = `Page ${pageNum}`;

            const pageCanvasContainer = document.createElement("div");
            pageCanvasContainer.className = "page-canvas-container";

            const pdfCanvas = document.createElement("canvas");
            const overlayCanvas = document.createElement("canvas");
            overlayCanvas.className = "overlay-canvas";

            pdfCanvas.width = viewport.width;
            pdfCanvas.height = viewport.height;
            overlayCanvas.width = viewport.width;
            overlayCanvas.height = viewport.height;

            pageCanvasContainer.appendChild(pdfCanvas);
            pageCanvasContainer.appendChild(overlayCanvas);

            wrapper.appendChild(label);
            wrapper.appendChild(pageCanvasContainer);

            pagesContainer.appendChild(wrapper);

            const pdfCtx = pdfCanvas.getContext("2d");
            const overlayCtx = overlayCanvas.getContext("2d");

            // Render PDF page
            await page.render({ canvasContext: pdfCtx, viewport }).promise;

            // Extract text items in PDF space
            const textContent = await page.getTextContent();
            const textItems = textContent.items.map((item, index) => {
              const [a, b, c, d, e, f] = item.transform;

              // PDF-space box: baseline as bottom
              const x1 = e;
              const y1 = f;
              const x2 = x1 + item.width;
              const y2 = y1 + item.height;

              return {
                index,
                str: item.str,
                pdfBox: { x1, y1, x2, y2 },
              };
            });

            // Register this page's context globally
            pageContexts[pageNum] = {
              textItems,
              viewport,
              overlayCtx,
              overlayCanvas,
            };

            // --- Events for this page ---

            // Drag selection (start)
            pdfCanvas.addEventListener("mousedown", (event) => {
              const { x, y } = getCanvasCoords(pdfCanvas, event);
              isDragging = true;
              currentPageBeingDragged = pageNum;
              dragStart = { x, y };
              dragEnd = { x, y };

              // Clear any live box, keep current highlights
              redrawGlobalHighlights();
            });

            // Drag selection (move)
            pdfCanvas.addEventListener("mousemove", (event) => {
              if (!isDragging || currentPageBeingDragged !== pageNum) return;

              const { x, y } = getCanvasCoords(pdfCanvas, event);
              dragEnd = { x, y };

              const sel = getSelectionRect();
              const newlySelected = [];
              for (const item of textItems) {
                const box = pdfBoxToCanvasBox(item.pdfBox, viewport);
                if (rectsIntersect(sel, box) && item.str != "" && item.str != " ") {
                  newlySelected.push(item);
                }
              }

              // Replace global selection with this drag's items
              selectedItems = newlySelected.map(item => ({
                pageNum,
                item,
              }));
              redrawGlobalHighlights(sel);
            });

            // Global mouseup handles finishing the drag
            window.addEventListener("mouseup", (event) => {
              if (!isDragging || currentPageBeingDragged !== pageNum) return;
              isDragging = false;

              const sel = getSelectionRect();

              const newlySelected = [];
              for (const item of textItems) {
                const box = pdfBoxToCanvasBox(item.pdfBox, viewport);
                if (rectsIntersect(sel, box) && item.str != "" && item.str != " ") {
                  newlySelected.push(item);
                }
              }

              // Replace global selection with this drag's items
              selectedItems = newlySelected.map(item => ({
                pageNum,
                item,
              }));

              redrawGlobalHighlights();
              currentPageBeingDragged = null;

              const combinedText = newlySelected.map(i => i.str).join(" ");
              infoDiv.textContent =
                `Drag selection on page ${pageNum}: ${newlySelected.length} items\n` +
                combinedText;
            });
          }
        </script>
    </body>
</html>
